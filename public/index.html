<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Welcome to Firebase Hosting</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/3.9.0/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/3.9.0/firebase-auth.js"></script>
    <script defer src="/__/firebase/3.9.0/firebase-database.js"></script>
    <script defer src="/__/firebase/3.9.0/firebase-messaging.js"></script>
    <script defer src="/__/firebase/3.9.0/firebase-storage.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>

    <script
      src="https://code.jquery.com/jquery-3.2.1.min.js"
      integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
      crossorigin="anonymous"></script>

    <script src="https://unpkg.com/vue"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <style media="screen">
      body { background: #ECEFF1; color: rgba(0,0,0,0.87); font-family: Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
      #comment { background: white; max-width: 720px; margin: 100px auto 16px; padding: 32px 24px; border-radius: 3px; }
      #comment h2 { color: #ffa100; font-weight: bold; font-size: 16px; margin: 0 0 8px; }
      #comment h1 { font-size: 22px; font-weight: 300; color: rgba(0,0,0,0.6); margin: 0 0 16px;}
      #comment p { line-height: 140%; margin: 16px 0 24px; font-size: 14px; }
      #comment a { display: block; text-align: center; background: #039be5; text-transform: uppercase; text-decoration: none; color: white; padding: 16px; border-radius: 4px; }
      #comment, #comment a { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
      #load { color: rgba(0,0,0,0.4); text-align: center; font-size: 13px; }
      @media (max-width: 600px) {
        body, #comment { margin-top: 0; background: white; box-shadow: none; }
        body { border-top: 16px solid #ffa100; }
      }
      #top-nav { max-width: 720px; margin: 12px auto 12px; }
      #top-nav .user-image { width: 30px;  }
      #comment-lists { 
        padding: 0px; 
      }
      #comment-lists li { 
        list-style-type: none;
        background: white; max-width: 720px; margin: 12px auto 12px; padding: 12px 24px; border-radius: 3px; 
        box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        -webkit-animation: fadein 2s; /* Safari, Chrome and Opera > 12.1 */
           -moz-animation: fadein 2s; /* Firefox < 16 */
            -ms-animation: fadein 2s; /* Internet Explorer */
             -o-animation: fadein 2s; /* Opera < 12.1 */
                animation: fadein 2s;
      }
      #comment-lists img { width: 50px; }
      #more { max-width: 720px; margin: 12px auto 12px; }
    </style>
  </head>
  <body>
    <div id="top-nav">
      <div v-if="fbuser != null" class="before-login float-right">
        <div class="row">
          <div class="col-md-2 user-name">{{ fbuser.displayName }}</div>
          <div class="col-md-1">
            <img v-bind:src="fbuser.photoURL" class="user-image">
          </div>
          <button class="col-md-2 btn" v-on:click="logout()"> logout</button>
        </div>
      </div>
      <div v-else class="after-login">
        <button class="facebook-login-button btn" v-on:click="loginFacebook()">
          <i class="fa fa-facebook-official" aria-hidden="true"></i> facebook
        </button>
        <button class="twitter-login-button btn" v-on:click="loginTwitter()">
          <i class="fa fa-twitter" aria-hidden="true"></i> twitter
        </button>
      </div>
    </div>
    <div id="comment">
      <h2>테크페미</h2>
      <h1>나의 두려움은 용기가 되어 돌아왔다</h1>
      <p>강남역여성살해1주기 추모행사 "나의 두려움은 용기가 되어 돌아왔다" 추모의 글을 올려주세요. 테크페미를 만나고 나의 성공시대 시작됐다. 테크페미를 만나고 나의 성공시대 시작됐다. 테크페미를 만나고 나의 성공시대 시작됐다. 테크페미를 만나고 나의 성공시대 시작됐다. 테크페미를 만나고 나의 성공시대 시작됐다. 테크페미를 만나고 나의 성공시대 시작됐다. 테크페미를 만나고 나의 성공시대 시작됐다. 테크페미를 만나고 나의 성공시대 시작됐다. 테크페미를 만나고 나의 성공시대 시작됐다. 테크페미를 만나고 나의 성공시대 시작됐다. 테크페미를 만나고 나의 성공시대 시작됐다. 테크페미를 만나고 나의 성공시대 시작됐다. 테크페미를 만나고 나의 성공시대 시작됐다. </p>
      <input type="text" class="input-comment form-control">
      <hr>
      <a href="" class="comment-submit-btn btn btn-large">전송</a>
    </div>
    <div id="">
      <ul id="comment-lists">
        <li v-for="data in datas">
          <div class="row">
            <div class="col-md-2 data-user-name">{{ data.username }}</div>
            <div class="col-md-2">
              <img v-bind:src="data.userPhotoUrl" class="data-user-image">
            </div>
            <div class="col-md-8 data-comment">{{ data.comment }}</div>
          </div>
        </li>
      </ul>
    </div>
    <div id="more">
      <a href="" class="more-btn btn btn-large">더보기</a>
    </div>
    <p id="load">Firebase SDK Loading&hellip;</p>

    <script>
      const requestCount = 5;
      let datas = [];
      let fbuser = null;
      let vue1, vue2;

      document.addEventListener('DOMContentLoaded', function() {
        // // 🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
        // // The Firebase SDK is initialized and available here!
        //
        // firebase.auth().onAuthStateChanged(user => { });
        // firebase.database().ref('/path/to/ref').on('data', snapshot => { });
        // firebase.messaging().requestPermission().then(() => { });
        // firebase.storage().ref('/path/to/ref').getDownloadURL().then(() => { });
        //
        // // 🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

        try {
          let app = firebase.app();
          let features = ['auth', 'database', 'messaging', 'storage'].filter(feature => typeof app[feature] === 'function');
          document.getElementById('load').innerHTML = `Firebase SDK loaded with ${features.join(', ')}`;
        } catch (e) {
          console.error(e);
          document.getElementById('load').innerHTML = 'Error loading the Firebase SDK, check the console.';
        }
        
        // document.getElementsByClassName('twitter-login-button')[0].addEventListener('click', function(event) {
        //   event.preventDefault();
        //   console.log('click twitter-login-button');
        //   loginTwitter();
        // });
   
        // document.getElementsByClassName('logout-button')[0].addEventListener('click', function(event) {
        //   event.preventDefault();
        //   console.log('click logout-button');
        //   logout();
        // });

        // document.getElementsByClassName('facebook-login-button')[0].addEventListener('click', function(event) {
        //   event.preventDefault();
        //   console.log('click facebook-login-button');
        //   loginFacebook();
        // });

        document.getElementsByClassName('comment-submit-btn')[0].addEventListener('click', function(event) {
          event.preventDefault();
          console.log('click comment-submit-btn');
          submitComment();
        });

        document.getElementsByClassName('more-btn')[0].addEventListener('click', function(event) {
          event.preventDefault();
          console.log('click more-btn');
          requestComments();
        });

        firebase.auth().onAuthStateChanged(function(auth) {
          vue2.fbuser = auth;
          console.log(fbuser);
        });

        vue1 = new Vue({
          el: '#comment-lists',
          data: {
            datas: datas
          }
        });

        vue2 = new Vue({
          el: '#top-nav',
          data: {
            fbuser: fbuser
          },
          methods: {
            logout: function() {
              requestLogout();
            },
            loginTwitter: function() {
              loginTwitter();
            },
            loginFacebook: function() {
              loginFacebook();
            }
          }
        })

        requestComments();

        firebase.database().ref().child('comments').orderByKey().limitToLast(requestCount).on('child_added',
          function(data) {
            let val = data.val();
            val['key'] = data.key;
            console.log('child_added');
            console.log(val);
            if ( datas.findIndex(x => x.key == data.key) == -1) {
              datas.unshift(val);
            }
          }
        );
      }); 

      function requestComments() {
        let count = datas.length;
        if (count > 0) {
          let lastKey = datas[count-1].key;
          // let firstKey = datas[0].key;

          firebase.database().ref().child('comments').orderByKey().endAt(lastKey).limitToLast(requestCount+1).once('value').then(
            function(snapshot) {
              processSnapshot(snapshot);
            }
          );  
        } else {
          firebase.database().ref().child('comments').orderByKey().limitToLast(requestCount).once('value').then(
            function(snapshot) {
              processSnapshot(snapshot);            
            }
          );
        }
      }

      function processSnapshot(snapshot) {
        newDatas = [];
        snapshot.forEach(function(childSnapshot) {
          let val = childSnapshot.val();
          val['key'] = childSnapshot.key;
          console.log(val);
          if ( datas.findIndex(x => x.key == childSnapshot.key) == -1) {
            newDatas.push(val);
          }
        });
        newDatas.reverse();
        newDatas.forEach(function(val) {
          datas.push(val);
        });
      }

      function submitComment() {
        let user = firebase.auth().currentUser;
        if (user == null) {
          alert('로그인을 해주세요');
          return;
        }

        let comment = document.getElementsByClassName('input-comment')[0].value;
        console.log(comment);

        let object = {
          username : user.displayName,
          userPhotoUrl : user.photoURL,
          comment : comment
        };

        // Get a key for a new Post.
        var newPostKey = firebase.database().ref().child('comments').push().key;

        var updates = {};
        updates['/comments/' + newPostKey] = object;

        firebase.database().ref().update(updates, function() {
          alert("success");
        });
      }

      function requestLogout() {
        firebase.auth().signOut();
      }

      function loginFacebook() {
        var provider = new firebase.auth.FacebookAuthProvider();
        provider.addScope('user_birthday');
        provider.setCustomParameters({
          'display': 'popup'
        });

        firebase.auth().signInWithPopup(provider).then(function(result) {
          // This gives you a Facebook Access Token. You can use it to access the Facebook API.
          var token = result.credential.accessToken;
          // The signed-in user info.
          var user = result.user;
          // ...
          console.log('success');

        }).catch(function(error) {
          // Handle Errors here.
          var errorCode = error.code;
          var errorMessage = error.message;
          // The email of the user's account used.
          var email = error.email;
          // The firebase.auth.AuthCredential type that was used.
          var credential = error.credential;
          // ...

          console.log('error');
          showError(error);
        });
      }

      function loginTwitter() {
        
        var provider = new firebase.auth.TwitterAuthProvider();
        provider.setCustomParameters({
          'lang': 'es'
        });

        firebase.auth().signInWithPopup(provider).then(function(result) {
          // This gives you a the Twitter OAuth 1.0 Access Token and Secret.
          // You can use these server side with your app's credentials to access the Twitter API.
          var token = result.credential.accessToken;
          var secret = result.credential.secret;
          // The signed-in user info.
          var user = result.user;
          // ...
          console.log('twitter success');

        }).catch(function(error) {
          // Handle Errors here.
          var errorCode = error.code;
          var errorMessage = error.message;
          // The email of the user's account used.
          var email = error.email;
          // The firebase.auth.AuthCredential type that was used.
          var credential = error.credential;
          // ...
          console.log('twitter error');
          showError(error);
        });
        //*/
      }

      function showError(error) {
        alert(error.message);
      }

    </script>
  </body>
</html>

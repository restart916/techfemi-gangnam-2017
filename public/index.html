<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>테크페미</title>
    <meta property="og:url"                content="https://techfemi-gangnam-2017-29012.firebaseapp.com/" />
    <meta property="og:type"               content="website" />
    <meta property="og:title"              content="테크페미" />
    <meta property="og:description"        content="나의 두려움은 용기가 되어 돌아왔다" />
    <meta property="og:image"              content="https://pbs.twimg.com/profile_images/835431700448452608/KnAWOGgR.jpg" />
    <meta property="fb:app_id" content="1409770342400157" />


    <!-- https://goo.gl/FY4AYK -->

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/3.9.0/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/3.9.0/firebase-auth.js"></script>
    <script defer src="/__/firebase/3.9.0/firebase-database.js"></script>
    <script defer src="/__/firebase/3.9.0/firebase-messaging.js"></script>
    <script defer src="/__/firebase/3.9.0/firebase-storage.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>

    <script
      src="https://code.jquery.com/jquery-3.2.1.min.js"
      integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
      crossorigin="anonymous"></script>

    <script src="https://unpkg.com/vue"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <style media="screen">
      body { background: #ECEFF1; color: rgba(0,0,0,0.87); font-family: Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
      #comment { background: white; max-width: 720px; margin: 100px auto 16px; padding: 32px 24px; border-radius: 3px; }
      #comment h2 { color: #ffa100; font-weight: bold; font-size: 16px; margin: 0 0 8px; }
      #comment h1 { font-size: 22px; font-weight: 300; color: rgba(0,0,0,0.6); margin: 0 0 16px;}
      #comment p { line-height: 140%; margin: 16px 0 24px; font-size: 14px; }
      #comment a.comment-submit-btn{ display: block; text-align: center; background: #039be5; text-transform: uppercase; text-decoration: none; color: white; padding: 16px; border-radius: 4px; }
      #comment, #comment a { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
      #load { color: rgba(0,0,0,0.4); text-align: center; font-size: 13px; }
      @media (max-width: 600px) {
        body, #comment { margin-top: 0; background: white; box-shadow: none; }
        body { border-top: 16px solid #ffa100; }
      }
      #top-nav { max-width: 720px; margin: 12px auto 12px; }
      #top-nav .user-image { width: 30px;  }
      #comment-lists { 
        padding: 0px; 
        text-align: center;
      }
      @font-face {
        font-family: KimNamyun;
        src: url(font/KimNamyun.ttf);
      }
      #comment-lists li { 
        overflow:hidden;
        padding:3em;
        margin:20px;
        /*float:left;*/
        text-decoration:none;
        color:#000;
        background:#ffc;
        display:inline-block; /* display:block; */
        height:16em;
        width:16em;
        padding:1em;
        -moz-box-shadow:5px 5px 7px rgba(33,33,33,1);
        -webkit-box-shadow: 5px 5px 7px rgba(33,33,33,.7);
        box-shadow: 5px 5px 7px rgba(33,33,33,.7);
        -moz-transition:-moz-transform .15s linear;
        -o-transition:-o-transform .15s linear;
        -webkit-transition:-webkit-transform .15s linear;



        /*
        list-style:none;
        list-style-type: none;
        background: white; max-width: 720px; margin: 12px auto 12px; padding: 12px 24px; border-radius: 3px; 
        box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        */
        -webkit-animation: fadein 2s; /* Safari, Chrome and Opera > 12.1 */
           -moz-animation: fadein 2s; /* Firefox < 16 */
            -ms-animation: fadein 2s; /* Internet Explorer */
             -o-animation: fadein 2s; /* Opera < 12.1 */
                animation: fadein 2s;
      }
      #comment-lists li .data-comment {
        font-family: KimNamyun;
        font-size: 25px;
      }
      #comment-lists li:nth-child(even){
        -o-transform:rotate(4deg);
        -webkit-transform:rotate(4deg);
        -moz-transform:rotate(4deg);
        position:relative;
        top:5px;
        background:#cfc;
      }
      #comment-lists li:nth-child(3n){
        -o-transform:rotate(-3deg);
        -webkit-transform:rotate(-3deg);
        -moz-transform:rotate(-3deg);
        position:relative;
        top:-5px;
        background:#ccf;
      }

      #comment-lists li:hover,#comment-lists li :focus{
        -moz-box-shadow:10px 10px 7px rgba(0,0,0,.7);
        -webkit-box-shadow: 10px 10px 7px rgba(0,0,0,.7);
        box-shadow:10px 10px 7px rgba(0,0,0,.7);
        -webkit-transform: scale(1.25);
        -moz-transform: scale(1.25);
        -o-transform: scale(1.25);
        position:relative;
        z-index:5;
      } 
      
      #comment-lists img { width: 50px; }
      #more { max-width: 720px; margin: 12px auto 12px; }
      #more a{ display: block; text-align: center; background: #039be5; text-transform: uppercase; text-decoration: none; color: white; padding: 16px; border-radius: 4px; }
      .submit-result {
        text-align: center;
        margin-bottom: 16px;
        padding: 16px 10px;
        background-color: rgb(107, 197, 70);
      }
    </style>
  </head>
  <body>
    <script>
      window.fbAsyncInit = function() {
        FB.init({
          appId      : '1409770342400157',
          xfbml      : true,
          version    : 'v2.9'
        });
        FB.AppEvents.logPageView();
      };

      (function(d, s, id){
         var js, fjs = d.getElementsByTagName(s)[0];
         if (d.getElementById(id)) {return;}
         js = d.createElement(s); js.id = id;
         js.src = "//connect.facebook.net/en_US/sdk.js";
         fjs.parentNode.insertBefore(js, fjs);
       }(document, 'script', 'facebook-jssdk'));
    </script>
    <div id="top-nav">
      <div v-if="fbuser != null" class="before-login float-right">
        <div class="row">
          <div class="col-md-2 user-name">{{ fbuser.displayName }}</div>
          <div class="col-md-1">
            <img v-bind:src="fbuser.photoURL" class="user-image">
          </div>
          <button class="col-md-2 btn" v-on:click="logout()"> logout</button>
        </div>
      </div>
      <div v-else class="after-login">
        <button class="facebook-login-button btn" v-on:click="loginFacebook()">
          <i class="fa fa-facebook-official" aria-hidden="true"></i> facebook 로그인
        </button>
        <button class="twitter-login-button btn" v-on:click="loginTwitter()">
          <i class="fa fa-twitter" aria-hidden="true"></i> twitter 로그인
        </button>
      </div>
    </div>
    <div id="comment">
      <h2>테크페미</h2>
      <h1>우리의 두려움은 용기가 되어 돌아왔다 - 범페미네트워크</h1>
      <p>한 장, 두 장, ... 그리고 2만 4천 개의 포스트잇. "한 개인으로 인해 저질러진 것이지만 그 배후에는 대한민국 사회라는 공범이 있다"는 공감대a)에서 모인 사람들이 남긴 메시지입니다.<br>
      나는, 그는, 우리는 사건 이전과 이후 똑같을 수 없고, 같아서도 안될 것입니다.<br>
      강남역 여성살해사건 1주기를 맞아, 물리적인 장소에 모두 모이지 못하더라도 여성혐오 없는 사회를 만들기 위한 생각들을 다시금 모아봅시다.<br>
      <br>
      추모와 평화의 메시지를 남겨주세요.<br>
      주변 사람들에게 공유해주시고, 목소리를 내어 함께 연대해주세요.<br>
      평등하고 정의롭기에 안전한 사회를 만들기 위한 노력에 동참해주세요. <br>
      <br>
      ※욕설 혹은 타인을 비방한 글은 홈페이지 관리자에 의해 임의삭제될 수 있으며, 이후 형사조치될 수 있음을 알려드립니다.<br>
      <br>
      <a href="http://www.ohmynews.com/NWS_Web/Mobile/at_pg.aspx?CNTN_CD=A0002211211&CMPT_CD=MMORE#cb" target="_blank">http://www.ohmynews.com/NWS_Web/Mobile/at_pg.aspx?CNTN_CD=A0002211211&CMPT_CD=MMORE#cb</a>
      </p>
      <input type="text" class="input-comment form-control">
      <hr>
      <div class="submit-result" style="opacity: -0.1; display: none;">등록되었습니다</div>
      <a href="" class="comment-submit-btn btn btn-large">전송</a>
    </div>
    <div id="">
      <ul id="comment-lists">
        <li v-for="data in datas">
          <div class="row">
            <div class="col-md-8 data-comment">{{ data.comment }} {{ data.datetime }}
            <a class="facebook-share-button btn" v-on:click="shareFacebook(data.comment)">
              <i class="fa fa-facebook-official" aria-hidden="true"></i>
            </a>
            <a class="twitter-share-button btn" v-bind:href="'http://twitter.com/share?url=https://goo.gl/FY4AYK&text='+data.comment" target="_blank">
              <i class="fa fa-twitter" aria-hidden="true"></i>
            </a>
            </div>
          </div>
        </li>
      </ul>
    </div>
    <div id="more">
      <a href="" class="more-btn btn btn-large">더보기</a>
    </div>
    <p id="load">Firebase SDK Loading&hellip;</p>

    <script>
      const requestCount = 9;
      let datas = [];
      let fbuser = null;
      let vue1, vue2;

      document.addEventListener('DOMContentLoaded', function() {
        // // 🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
        // // The Firebase SDK is initialized and available here!
        //
        // firebase.auth().onAuthStateChanged(user => { });
        // firebase.database().ref('/path/to/ref').on('data', snapshot => { });
        // firebase.messaging().requestPermission().then(() => { });
        // firebase.storage().ref('/path/to/ref').getDownloadURL().then(() => { });
        //
        // // 🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

        try {
          let app = firebase.app();
          let features = ['auth', 'database', 'messaging', 'storage'].filter(feature => typeof app[feature] === 'function');
          document.getElementById('load').innerHTML = `Firebase SDK loaded with ${features.join(', ')}`;
        } catch (e) {
          console.error(e);
          document.getElementById('load').innerHTML = 'Error loading the Firebase SDK, check the console.';
        }
        
        // document.getElementsByClassName('twitter-login-button')[0].addEventListener('click', function(event) {
        //   event.preventDefault();
        //   console.log('click twitter-login-button');
        //   loginTwitter();
        // });
   
        // document.getElementsByClassName('logout-button')[0].addEventListener('click', function(event) {
        //   event.preventDefault();
        //   console.log('click logout-button');
        //   logout();
        // });

        // document.getElementsByClassName('facebook-login-button')[0].addEventListener('click', function(event) {
        //   event.preventDefault();
        //   console.log('click facebook-login-button');
        //   loginFacebook();
        // });

        document.getElementsByClassName('comment-submit-btn')[0].addEventListener('click', function(event) {
          event.preventDefault();
          console.log('click comment-submit-btn');
          submitComment();
        });

        document.getElementsByClassName('more-btn')[0].addEventListener('click', function(event) {
          event.preventDefault();
          console.log('click more-btn');
          requestComments();
        });

        document.getElementsByClassName('more-btn')[0].addEventListener('click', function(event) {
          event.preventDefault();
          console.log('click more-btn');
          requestComments();
        });

        firebase.auth().onAuthStateChanged(function(auth) {
          vue2.fbuser = auth;
          // console.log(fbuser);
        });

        vue1 = new Vue({
          el: '#comment-lists',
          data: {
            datas: datas
          },
          methods: {
            shareFacebook: function(message) {
              shareFacebook(message);
            }
          }
        });

        vue2 = new Vue({
          el: '#top-nav',
          data: {
            fbuser: fbuser
          },
          methods: {
            logout: function() {
              requestLogout();
            },
            loginTwitter: function() {
              loginTwitter();
            },
            loginFacebook: function() {
              loginFacebook();
            }
          }
        })

        requestComments();

        firebase.database().ref().child('comments').orderByKey().limitToLast(requestCount).on('child_added',
          function(data) {
            let val = data.val();
            val['key'] = data.key;
            if ( datas.findIndex(x => x.key == data.key) == -1) {
              datas.unshift(val);
            }
          }
        );
      }); 

      function shareFacebook(message) {
        FB.ui({
          method: 'share',
          display: 'popup',
          href: 'https://techfemi-gangnam-2017-29012.firebaseapp.com/',
          hashtag: '#테크페미를_만나고_나의_성공시대_시작됐다',
          quote: message,

        }, function(response){});
      }

      function requestComments() {
        let count = datas.length;
        if (count > 0) {
          let lastKey = datas[count-1].key;
          // let firstKey = datas[0].key;

          firebase.database().ref().child('comments').orderByKey().endAt(lastKey).limitToLast(requestCount+1).once('value').then(
            function(snapshot) {
              processSnapshot(snapshot);
            }
          );  
        } else {
          firebase.database().ref().child('comments').orderByKey().limitToLast(requestCount).once('value').then(
            function(snapshot) {
              processSnapshot(snapshot);            
            }
          );
        }
      }

      function processSnapshot(snapshot) {
        newDatas = [];
        snapshot.forEach(function(childSnapshot) {
          let val = childSnapshot.val();
          val['key'] = childSnapshot.key;
          val['datetime'] = new Date(childSnapshot.datetime);
          // console.log(val);
          if ( datas.findIndex(x => x.key == childSnapshot.key) == -1) {
            newDatas.push(val);
          }
        });
        newDatas.reverse();
        newDatas.forEach(function(val) {
          datas.push(val);
        });
      }

      function submitComment() {
        let user = firebase.auth().currentUser;
        if (user == null) {
          showMessage("로그인을 해주세요");
          return;
        }

        document.getElementsByClassName('comment-submit-btn')[0].disabled = true;
        let comment = document.getElementsByClassName('input-comment')[0].value;

        if (comment.trim() == '') {
          showMessage("내용을 입력해주세요");
          return;
        }

        let len = comment.length;
        if (len > 140) {
          showMessage("내용은 140자를 넘을 수 없습니다.");
          return;  
        }

        // console.log(comment);
        let object = {
          uid : user.uid,
          username : user.displayName,
          userPhotoUrl : user.photoURL,
          comment : comment,
        };

        // Get a key for a new Post.
        var newPostKey = firebase.database().ref().child('comments').push().key;

        var updates = {};
        updates['/comments/' + newPostKey] = object;

        firebase.database().ref().update(updates, function() {
          document.getElementsByClassName('comment-submit-btn')[0].disabled = false;
          document.getElementsByClassName('input-comment')[0].value = '';

          showMessage("정상적으로 등록되었습니다.");
        });
      }

      function requestLogout() {
        firebase.auth().signOut();
      }

      function loginFacebook() {
        var provider = new firebase.auth.FacebookAuthProvider();
        provider.addScope('user_birthday');
        provider.setCustomParameters({
          'display': 'popup'
        });

        firebase.auth().signInWithPopup(provider).then(function(result) {
          // This gives you a Facebook Access Token. You can use it to access the Facebook API.
          var token = result.credential.accessToken;
          // The signed-in user info.
          var user = result.user;
          // ...
          console.log('success');

        }).catch(function(error) {
          // Handle Errors here.
          var errorCode = error.code;
          var errorMessage = error.message;
          // The email of the user's account used.
          var email = error.email;
          // The firebase.auth.AuthCredential type that was used.
          var credential = error.credential;
          // ...

          console.log('error');
          showMessage("로그인을 실패했습니다. 다시 시도해 주세요.");
        });
      }

      function loginTwitter() {
        
        var provider = new firebase.auth.TwitterAuthProvider();
        provider.setCustomParameters({
          'lang': 'es'
        });

        firebase.auth().signInWithPopup(provider).then(function(result) {
          // This gives you a the Twitter OAuth 1.0 Access Token and Secret.
          // You can use these server side with your app's credentials to access the Twitter API.
          var token = result.credential.accessToken;
          var secret = result.credential.secret;
          // The signed-in user info.
          var user = result.user;
          // ...
          console.log('twitter success');

        }).catch(function(error) {
          // Handle Errors here.
          var errorCode = error.code;
          var errorMessage = error.message;
          // The email of the user's account used.
          var email = error.email;
          // The firebase.auth.AuthCredential type that was used.
          var credential = error.credential;
          // ...
          console.log('twitter error');
          showMessage("로그인을 실패했습니다. 다시 시도해 주세요.");
        });
        //*/
      }

      function showMessage(message) {
        var result = document.getElementsByClassName('submit-result')[0];
        result.innerHTML = message
        fadeIn(result);
        setTimeout(function() {
          fadeOut(result);
        }, 1300);
      }


      // fade out
      function fadeOut(el) {
        var op = 1;
        var timer = setInterval(function () {
          if (op <= 0.1){
            clearInterval(timer);
            el.style.display = 'none';
          }
          el.style.opacity = op;
          op -= op * 0.1;
        }, 10);
      }

      // fade in
      function fadeIn(el) {
        var op = 0;
        el.style.opacity = op;
        el.style.display = '';
        
        var timer = setInterval(function () {
          if (op >= 1.0){
            clearInterval(timer);
          }
          el.style.opacity = op;
          op = op + 0.1;
        }, 30);
      }

    </script>
  </body>
</html>
